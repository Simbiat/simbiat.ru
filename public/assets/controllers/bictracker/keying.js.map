{"version":3,"file":"keying.js","sourceRoot":"/js/Pages/","sources":["bictracker/keying.ts"],"names":[],"mappings":"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","sourcesContent":["export class bicKeying {\r\n  private readonly form: HTMLFormElement | null = null;\r\n  private readonly result: HTMLSpanElement | null = null;\r\n  private readonly bicKeySample: HTMLSpanElement | null = null;\r\n  private readonly accKeySample: HTMLSpanElement | null = null;\r\n  private readonly spinner: HTMLImageElement | null = null;\r\n\r\n  public constructor() {\r\n    this.form = document.querySelector('#bic_keying');\r\n    this.result = document.querySelector('#acc_check_result');\r\n    this.bicKeySample = document.querySelector('#bic_key_sample');\r\n    this.accKeySample = document.querySelector('#account_key_sample');\r\n    this.spinner = document.querySelector('#bic_spinner');\r\n    ['change', 'input', 'paste'].forEach((eventType: string) => {\r\n      document.querySelector('#bic_key')\r\n              ?.addEventListener(eventType, () => {\r\n                this.calc();\r\n              });\r\n      document.querySelector('#account_key')\r\n              ?.addEventListener(eventType, () => {\r\n                this.calc();\r\n              });\r\n    });\r\n  }\r\n\r\n  private calc(): boolean {\r\n    if (this.form && this.result && this.bicKeySample && this.accKeySample) {\r\n      //Get form data\r\n      const formData = new FormData(this.form);\r\n      const bicKey = String(formData.get('bic_key') ?? '');\r\n      const accKey = String(formData.get('account_key') ?? '');\r\n      this.result.classList.remove(...this.result.classList);\r\n      if ((/^\\d{9}$/u).exec(bicKey) === null) {\r\n        this.result.classList.add('failure');\r\n        this.result.innerHTML = 'Неверный формат БИКа';\r\n        bicKeying.styleBic(this.bicKeySample, 'warning', 'БИК');\r\n        return false;\r\n      }\r\n      bicKeying.styleBic(this.bicKeySample, 'success', bicKey);\r\n      if ((/^\\d{5}[\\dАВСЕНКМРТХавсенкмртх]\\d{14}$/u).exec(accKey) === null) {\r\n        this.result.classList.add('failure');\r\n        this.result.innerHTML = 'Неверный формат счёта';\r\n        bicKeying.styleBic(this.accKeySample, 'warning', 'СЧЁТ');\r\n        return false;\r\n      }\r\n      bicKeying.styleBic(this.accKeySample, 'success', accKey);\r\n      //Initiate request\r\n      this.result.classList.add('warning');\r\n      this.result.innerHTML = 'Проверяем...';\r\n      if (this.spinner) {\r\n        this.spinner.classList.remove('hidden');\r\n      }\r\n      void ajax(`${location.protocol}//${location.host}/api/bictracker/keying`, formData, 'json', 'POST', AJAX_TIMEOUT, true)\r\n        .then((response) => {\r\n          const data = response as ajaxJSONResponse;\r\n          //Change address\r\n          updateHistory(`${location.protocol}//${location.host}/bictracker/keying/${bicKey}/${accKey}/`, `Ключевание счёта ${accKey}`);\r\n          if (this.result) {\r\n            this.result.classList.remove(...this.result.classList);\r\n            if (data.data === true) {\r\n              this.result.classList.add('success');\r\n              this.result.innerHTML = 'Правильное ключевание';\r\n            } else {\r\n              this.result.classList.add('failure');\r\n              if (data.data === false) {\r\n                this.result.innerHTML = 'Непредвиденная ошибка';\r\n              } else {\r\n                this.result.innerHTML = `Неверное ключевание. Ожидаемый ключ: ${data.data} (${accKey.replace(/(?<beforeKey>^\\d{5}[\\dАВСЕНКМРТХавсенкмртх]\\d{2})(?<key>\\d)(?<afterKey>\\d{11})$/u, `$<beforeKey><span class=\"success\">${data.data}</span>$<afterKey>`)})`;\r\n              }\r\n            }\r\n          }\r\n          if (this.spinner) {\r\n            this.spinner.classList.add('hidden');\r\n          }\r\n          return true;\r\n        });\r\n    }\r\n    return false;\r\n  }\r\n\r\n  //Helper function for styling\r\n  private static styleBic(element: HTMLSpanElement, newClass: string, text = ''): void {\r\n    element.classList.remove(...element.classList);\r\n    element.classList.add(newClass);\r\n    element.innerHTML = text;\r\n  }\r\n}\r\n"]}